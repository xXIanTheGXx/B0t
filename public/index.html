<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Server Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="nav-header">
        <div class="brand">B0t Scanner</div>
        <a href="/" class="active">Scanner</a>
        <a href="/map.html">Map</a>
        <a href="/database.html">Database</a>
        <a href="/settings.html">Settings</a>
    </div>

    <div class="container">
        <!-- Progress Section -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-end mb-2">
                    <h5 class="card-title m-0">Scan Progress</h5>
                    <div id="stats" class="text-end">
                        <span class="me-3">Current IP: <span id="currentIp" class="text-info">Idle</span></span>
                        <span class="me-3">Rate: <span id="scanRate" class="text-success">0</span> IPs/s</span>
                    </div>
                </div>
                <div class="progress">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-5 mb-4">
                 <!-- Configuration Removed - Moved to Settings -->
                 <div class="card h-100 d-flex flex-column justify-content-center align-items-center p-4">
                    <h5 class="mb-3">Scanner Controls</h5>
                    <div class="d-grid gap-2 w-100">
                        <button id="startBtn" class="btn btn-primary btn-lg">Start Scan</button>
                        <button id="stopBtn" class="btn btn-danger btn-lg" disabled>Stop Scan</button>
                        <a href="/settings.html" class="btn btn-secondary">Configure Settings</a>
                    </div>
                    <small class="text-muted mt-3 text-center">Configure scanning parameters in Settings.</small>
                 </div>
            </div>

            <div class="col-lg-7">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Logs</span>
                        <div>
                            <span class="badge bg-primary me-2">Found: <span id="foundCount">0</span></span>
                            <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('logs').innerHTML = ''">Clear</button>
                        </div>
                    </div>
                    <div class="card-body p-0 d-flex flex-column" style="height: 600px;">
                        <div id="logs" class="flex-grow-1 mb-2" style="margin: 10px; overflow-y: scroll;"></div>
                        <div class="border-top border-secondary p-2 bg-dark">
                            <h6 class="text-white mb-2">Recent Results</h6>
                            <div id="results" class="list-group list-group-flush" style="height: 200px; overflow-y: scroll;">
                                <!-- Results -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const logsDiv = document.getElementById('logs');
        const resultsDiv = document.getElementById('results');
        const foundCountBadge = document.getElementById('foundCount');

        let foundCount = 0;

        // Start Scan - Load from localStorage
        startBtn.addEventListener('click', () => {
            const settings = JSON.parse(localStorage.getItem('scannerSettings')) || {};

            // Defaults if not set
            const startIp = settings.network?.startIp;
            const endIp = settings.network?.endIp;

            if (!startIp || !endIp) {
                alert('Please configure Start IP and End IP in Settings first!');
                return;
            }

            const email = settings.network?.email;
            const authPassword = settings.network?.authPassword;
            const useAuth = settings.network?.useAuth;

            let authOptions = { auth: 'offline' };
            if (useAuth) {
                authOptions = { auth: 'microsoft', username: email };
                if (authPassword) {
                    authOptions.password = authPassword;
                }
            }

            const botSettings = {
                features: {
                    structureScan: settings.bot?.structureScan !== false,
                    blockBreaking: settings.bot?.blockBreaking !== false
                },
                structureBlocks: settings.bot?.structureBlocks ? settings.bot.structureBlocks.split(',').map(s => s.trim()).filter(s => s.length > 0) : []
            };
            if (botSettings.structureBlocks.length === 0) delete botSettings.structureBlocks;

            // Modules
            const looting = {
                enabled: settings.modules?.looting || false,
                wishlist: settings.modules?.lootWishlist ? settings.modules.lootWishlist.split(',').map(s=>s.trim()).filter(s=>s) : []
            };
            const agent = { enabled: settings.modules?.agent || false };
            const discord = { webhookUrl: settings.modules?.discordUrl || '' };
            const inventoryViewer = { enabled: settings.modules?.inventory || false };

            const masscanRate = parseInt(settings.network?.masscanRate) || 1000;
            const proxies = settings.network?.proxies ? settings.network.proxies.split('\n').map(s=>s.trim()).filter(s=>s) : [];

            // Database - Update if needed (Though user should have updated in settings)
            if (settings.database) {
                 const dbHost = settings.database.host || '127.0.0.1';
                 const dbPort = settings.database.port || '27017';
                 const dbName = settings.database.name || 'minecraft_scanner';
                 const dbUser = settings.database.user;
                 const dbPass = settings.database.pass;

                 let uri = `mongodb://`;
                 if (dbUser && dbPass) {
                    uri += `${encodeURIComponent(dbUser)}:${encodeURIComponent(dbPass)}@`;
                 }
                 uri += `${dbHost}:${dbPort}/${dbName}`;

                 // Emit update database just in case
                 socket.emit('update-database', { uri });
            }


            const payload = {
                startIp, endIp,
                authOptions,
                bot: botSettings,
                looting, agent, discord, inventoryViewer,
                masscan: { rate: masscanRate },
                proxies
            };

            socket.emit('start-scan', payload);

            startBtn.disabled = true;
            stopBtn.disabled = false;
            logsDiv.innerHTML = '';
            resultsDiv.innerHTML = '';
            foundCount = 0;
            foundCountBadge.textContent = '0';

            // Reset progress
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            document.getElementById('scanRate').textContent = '0';

            addLog('Requesting scan start...');
        });

        stopBtn.addEventListener('click', () => {
            socket.emit('stop-scan');
        });

        function addLog(msg) {
            const p = document.createElement('div');
            p.textContent = `> ${msg}`;
            logsDiv.appendChild(p);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        socket.on('log', (msg) => {
            addLog(msg);
        });

        socket.on('progress', (data) => {
            document.getElementById('progressBar').style.width = data.percent + '%';
            document.getElementById('progressBar').textContent = data.percent + '%';
            document.getElementById('currentIp').textContent = data.currentIp;
            document.getElementById('scanRate').textContent = data.rate;
        });

        socket.on('error', (msg) => {
            addLog('ERROR: ' + msg);
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });

        socket.on('scan-started', (info) => {
            addLog(`Scan started: ${info.startIp} - ${info.endIp} (${info.total} IPs)`);
        });

        socket.on('scan-complete', () => {
            addLog('Scan complete.');
            startBtn.disabled = false;
            stopBtn.disabled = true;
            document.getElementById('progressBar').classList.remove('progress-bar-animated');
        });

        socket.on('result', (data) => {
            foundCount++;
            foundCountBadge.textContent = foundCount;

            const item = document.createElement('div');
            item.className = 'list-group-item';

            let structuresHtml = '';
            if (data.structures && data.structures.length > 0) {
                structuresHtml = `<small class="d-block text-info">Structures: ${data.structures.join(', ')}</small>`;
            }

            let breakHtml = '';
            if (data.canBreakBlocks) {
                breakHtml = '<span class="badge bg-success server-badge">Breakable</span>';
            } else if (data.spawnProtection) {
                breakHtml = '<span class="badge bg-warning text-dark server-badge">Protected</span>';
            }

            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1 text-primary pointer" onclick="copyToClipboard('${data.ip}')" style="cursor:pointer">${data.ip}:${data.port} <small class="text-muted">(Click to copy)</small></h6>
                </div>
                <p class="mb-1" style="font-size:0.85rem">
                    <span class="badge bg-secondary">${data.version || 'Unknown'}</span>
                    <span class="badge bg-info text-dark">Players: ${data.players.online}/${data.players.max}</span>
                    ${breakHtml}
                </p>
                ${structuresHtml}
            `;
            resultsDiv.insertBefore(item, resultsDiv.firstChild); // Prepend
        });

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                addLog(`Copied IP: ${text}`);
            }).catch(err => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                addLog(`Copied IP: ${text}`);
            });
        }

        socket.on('db-update-status', (msg) => {
            addLog(msg);
        });
    </script>
</body>
</html>
