<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Server Database</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .table-dark {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .table-dark th, .table-dark td {
            border-color: #34495e;
        }
    </style>
</head>
<body>
    <div class="nav-header">
        <div class="brand">B0t Scanner</div>
        <a href="/">Scanner</a>
        <a href="/map.html">Map</a>
        <a href="/database.html" class="active">Database</a>
    </div>

    <div class="container mt-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Scanned Servers</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadServers(1)">Refresh</button>
                </div>
            </div>
            <div class="card-body">
                 <!-- Filters -->
                 <div class="row mb-3 g-2">
                     <div class="col-md-3">
                         <input type="text" id="filterVersion" class="form-control form-control-sm" placeholder="Version (e.g. 1.20)">
                     </div>
                     <div class="col-md-3">
                         <input type="text" id="filterSoftware" class="form-control form-control-sm" placeholder="Software (e.g. Paper)">
                     </div>
                     <div class="col-md-2">
                         <input type="number" id="filterMinPlayers" class="form-control form-control-sm" placeholder="Min Players">
                     </div>
                     <div class="col-md-2">
                         <button class="btn btn-sm btn-primary w-100" onclick="loadServers(1)">Search</button>
                     </div>
                 </div>

                <div class="table-responsive">
                    <table class="table table-hover table-dark table-striped">
                        <thead>
                            <tr>
                                <th>IP:Port</th>
                                <th>Version</th>
                                <th>Players</th>
                                <th>Description (MOTD)</th>
                                <th>Location</th>
                                <th>Last Seen</th>
                            </tr>
                        </thead>
                        <tbody id="serverTableBody">
                            <tr><td colspan="6" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav>
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        const limit = 20;

        async function loadServers(page) {
            currentPage = page;
            const version = document.getElementById('filterVersion').value;
            const software = document.getElementById('filterSoftware').value;
            const minPlayers = document.getElementById('filterMinPlayers').value;

            let url = `/api/servers?page=${page}&limit=${limit}`;
            if(version) url += `&version=${encodeURIComponent(version)}`;
            if(software) url += `&software=${encodeURIComponent(software)}`;
            if(minPlayers) url += `&minPlayers=${minPlayers}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                renderTable(data.servers);
                renderPagination(data.page, data.total, data.limit);
            } catch (e) {
                console.error(e);
                document.getElementById('serverTableBody').innerHTML = '<tr><td colspan="6" class="text-danger">Error loading data</td></tr>';
            }
        }

        function renderTable(servers) {
            const tbody = document.getElementById('serverTableBody');
            tbody.innerHTML = '';

            if (servers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No servers found</td></tr>';
                return;
            }

            servers.forEach(server => {
                const date = new Date(server.lastSeen).toLocaleString();
                const motd = server.motd ? (server.motd.clean || server.motd.raw || '').substring(0, 50) : '';
                const loc = server.geo ? `${server.geo.city || ''}, ${server.geo.country || ''}` : 'Unknown';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${server.ip}:${server.port}</td>
                    <td>${server.version ? server.version.name : 'Unknown'}</td>
                    <td>${server.players ? server.players.online + '/' + server.players.max : '0/0'}</td>
                    <td>${motd}</td>
                    <td>${loc}</td>
                    <td>${date}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPagination(page, total, limit) {
            const totalPages = Math.ceil(total / limit);
            const nav = document.getElementById('pagination');
            nav.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${page === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadServers(${page - 1}); return false;">Previous</a>`;
            nav.appendChild(prevLi);

            // Pages (simplified window)
            let start = Math.max(1, page - 2);
            let end = Math.min(totalPages, page + 2);

            for (let i = start; i <= end; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="loadServers(${i}); return false;">${i}</a>`;
                nav.appendChild(li);
            }

            // Next
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${page === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadServers(${page + 1}); return false;">Next</a>`;
            nav.appendChild(nextLi);
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => loadServers(1));
    </script>
</body>
</html>
